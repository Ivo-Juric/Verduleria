{% extends "base.html" %}
{% block contenido %}

<h3>Finalizar venta - Métodos de pago</h3>

<h4>Resumen del carrito</h4>

<table class="table table-sm">
<thead>
<tr>
    <th>Producto</th>
    <th>Cantidad</th>
    <th>Precio Unit.</th>
    <th>Subtotal</th>
</tr>
</thead>
<tbody>
{% for item in carrito %}
<tr>
    <td>{{ item.nombre }}</td>
    <td>{{ item.cantidad }} {{ item.unidad or '' }}</td>
    <td>${{ item.precio }}</td>
    <td>${{ item.subtotal }}</td>
</tr>
{% endfor %}
</tbody>
</table>

<div class="alert alert-info">
    <strong>Total a pagar: ${{ total }}</strong>
</div>

<hr>

<h4>Métodos de pago</h4>

<form method="POST" action="{{ url_for('ventas.agregar_metodo_pago') }}" class="row g-3 mb-4">
    <div class="col-md-5">
        <label>Método de pago</label>
        <select name="metodo" class="form-control" required>
            <option value="">-- Seleccionar método --</option>
            {% for metodo in metodos %}
            <option value="{{ metodo.nombre }}">{{ metodo.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-5">
        <label>Monto</label>
        <input type="number" step="0.01" min="0.01" name="monto" class="form-control" placeholder="0.00" required>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Agregar pago</button>
    </div>
</form>

<h5>Pagos registrados</h5>

{% if metodos_pago_session %}
<table class="table table-sm table-bordered">
<thead>
<tr>
    <th>Método</th>
    <th>Monto</th>
    <th></th>
</tr>
</thead>
<tbody>
{% for pago in metodos_pago_session %}
<tr>
    <td>{{ pago.metodo }}</td>
    <td>${{ pago.monto }}</td>
    <td>
        <a href="{{ url_for('ventas.quitar_metodo_pago', idx=loop.index0) }}" class="btn btn-sm btn-danger">Quitar</a>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

<div class="alert alert-warning">
    <strong>Monto pagado: ${{ monto_pagado }}</strong><br>
    {% if falta_pagar > 0.01 %}
    <strong class="text-danger">Falta pagar: ${{ falta_pagar }}</strong>
    {% elif falta_pagar < -0.01 %}
    <strong class="text-danger">Excedente: ${{ -falta_pagar }}</strong>
    {% else %}
    <strong class="text-success">✓ Monto correcto</strong>
    {% endif %}
</div>

{% else %}
<div class="alert alert-info">
    No hay métodos de pago registrados. Agrega al menos uno.
</div>
{% endif %}

<div class="mt-4">
    <a href="{{ url_for('ventas.nueva') }}" class="btn btn-secondary">Volver</a>

    {% if falta_pagar <= 0.01 %}
    <form method="POST" class="d-inline">
        <button type="submit" class="btn btn-success">Finalizar venta</button>
    </form>
    {% else %}
    <button class="btn btn-success" disabled title="Completa el pago total">Finalizar venta</button>
    {% endif %}
</div>

{% endblock %}
