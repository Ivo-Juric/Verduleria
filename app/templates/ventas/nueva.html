{% extends "base.html" %}
{% block contenido %}

<h3>Nueva venta</h3>

<form method="POST" class="row g-3" autocomplete="off">

    <!-- hidden que almacena el id del producto seleccionado -->
    <input type="hidden" name="producto_id" id="producto_id_hidden">

    <div class="col-md-6 position-relative">
        <label>Producto</label>
        <!-- input visible donde el usuario escribe -->
        <input id="searchProducto" name="producto_nombre" class="form-control" autocomplete="off">
        <!-- contenedor de sugerencias (position absolute para superponer) -->
        <div id="sugerencias" class="list-group position-absolute w-100" style="z-index:1000;"></div>
    </div>

    <div class="col-md-3">
        <label>Cantidad</label>
        <input name="cantidad" type="number" step="0.01" class="form-control" value="1" min="0.01">
        <small id="stock-warning" class="text-danger d-none"></small>
    </div>

    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Agregar</button>
    </div>
</form>

<hr>

<h4>Carrito</h4>

<table class="table table-bordered">
<thead>
<tr>
    <th>Producto</th>
    <th>Unidad</th>
    <th>Cantidad</th>
    <th>Precio Unit.</th>
    <th>Subtotal</th>
    <th></th>
</tr>
</thead>
<tbody>
{% if carrito %}
    {% for item in carrito %}
    <tr {% if item.tiene_oferta %}class="table-warning"{% endif %}>
        <td>
            {{item.nombre}}
            {% if item.tiene_oferta %}
            <br><small class="text-success">{{item.descripcion_oferta}}</small>
            {% endif %}
        </td>
        <td>{{item.unidad or "-"}}</td>
        <td>{{item.cantidad}}</td>
        <td>
            {% if item.tiene_oferta %}
                <span class="text-decoration-line-through text-muted">${{item.precio_original}}</span><br>
                <span class="text-success">${{item.precio}}</span>
            {% else %}
                ${{item.precio}}
            {% endif %}
        </td>
        <td>${{item.subtotal}}</td>
        <td><a href="{{ url_for('ventas.quitar', idx=loop.index0) }}" class="btn btn-sm btn-danger">Quitar</a></td>
    </tr>
    {% endfor %}
{% else %}
    <tr>
        <td colspan="6" class="text-center">Carrito vacío</td>
    </tr>
{% endif %}
</tbody>
</table>

<h4>Total: ${{total}}</h4>

{% if carrito %}
<div class="mb-3">
    <a href="{{ url_for('ventas.finalizar') }}" class="btn btn-success">Finalizar venta</a>
</div>
{% endif %}



<script>
// Validación de cantidad contra stock
document.addEventListener("DOMContentLoaded", () => {
    const input = document.querySelector("#searchProducto");
    const cantidadInput = document.querySelector("input[name='cantidad']");
    const stockWarning = document.querySelector("#stock-warning");
    let stockDisponible = null;

    if (input) {
        input.addEventListener("change", () => {
            // Cuando cambia el input, capturamos el stock disponible
            const item = document.querySelector(`[data-stock]`);
            if (item) {
                stockDisponible = parseFloat(item.dataset.stock);
            }
        });
    }

    if (cantidadInput) {
        cantidadInput.addEventListener("input", () => {
            const cantidad = parseFloat(cantidadInput.value);
            const hiddenId = document.querySelector("#producto_id_hidden").value;

            if (hiddenId && cantidad > 0) {
                // Buscar el stock del producto seleccionado
                fetch(`/productos/stock/${hiddenId}`)
                    .then(r => r.json())
                    .then(data => {
                        if (cantidad > data.stock) {
                            stockWarning.textContent = `⚠️ Stock insuficiente. Disponible: ${data.stock}`;
                            stockWarning.classList.remove("d-none");
                        } else {
                            stockWarning.classList.add("d-none");
                        }
                    });
            }
        });
    }
});
</script>

{% endblock %}
